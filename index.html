<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Enhanced Rent Affordability Calculator</title>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,500&display=swap" rel="stylesheet">
  <style>
    /* Base styling */
    body {
      font-family: 'Roboto', sans-serif;
      margin: 0;
      padding: 20px;
      transition: background 0.3s, color 0.3s;
    }
    /* Light and Dark themes */
    body.light {
      background: #f0f8ff;
      color: #333;
    }
    body.dark {
      background: #2c2c2c;
      color: #ddd;
    }
    .container {
      background: #fff;
      padding: 20px;
      margin: auto;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      max-width: 500px;
    }
    body.dark .container {
      background: #3c3c3c;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
    }
    h1 {
      text-align: center;
      margin-bottom: 10px;
    }
    label {
      font-weight: 500;
      display: block;
      margin-bottom: 5px;
    }
    input, button {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      font-size: 1em;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
      transition: background 0.3s, color 0.3s, border-color 0.3s;
    }
    body.dark input, body.dark button {
      background: #555;
      color: #eee;
      border-color: #777;
    }
    button {
      background-color: #007BFF;
      color: #fff;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
    .result {
      font-size: 1.1em;
      font-weight: 500;
      text-align: center;
      margin-bottom: 10px;
    }
    /* Canvas styling */
    canvas {
      border: 1px solid #ccc;
      border-radius: 4px;
      background: #fff;
      display: block;
      margin: 0 auto;
    }
    body.dark canvas {
      background: #444;
      border-color: #666;
    }
    /* Toggle Button */
    #toggleTheme {
      margin: auto;
      display: block;
      max-width: 200px;
      margin-bottom: 20px;
      padding: 8px 12px;
      font-size: 0.9em;
    }
    /* Secret Button */
    #secretButton {
      position: fixed;
      bottom: 10px;
      right: 10px;
      background: #007BFF;
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      opacity: 0.5;
      cursor: pointer;
      font-size: 1.2em;
    }
    #secretButton:hover {
      opacity: 0.8;
    }
    /* Secret Game Overlay */
    #gameContainer {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 1000;
    }
    #gameContent {
      position: relative;
      margin: auto;
      top: 50%;
      transform: translateY(-50%);
      background: #fff;
      width: 90%;
      max-width: 500px;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }

    /* --- TABS STYLING --- */
    .tab {
      overflow: hidden;
      border-bottom: 1px solid #ccc;
      margin-bottom: 20px;
    }
    .tab button {
      background-color: inherit;
      float: left;
      border: none;
      outline: none;
      cursor: pointer;
      padding: 14px 16px;
      transition: 0.3s;
      font-size: 1em;
    }
    .tab button:hover {
      background-color: #ddd;
    }
    .tab button.active {
      background-color: #ccc;
    }
    .tabcontent {
      display: none; /* Hidden by default; will be shown when active */
    }
  </style>
</head>
<body class="light">
  <!-- Dark/Light mode toggle -->
  <button id="toggleTheme">Switch to Dark Mode</button>

  <!-- TAB BUTTONS -->
  <div class="tab">
    <button class="tablinks" onclick="openTab(event, 'affordabilityTab')" id="defaultOpen">
      Rent Affordability
    </button>
    <button class="tablinks" onclick="openTab(event, 'rentIncreaseTab')">
      Rent Increase
    </button>
  </div>

  <!-- TAB 1: AFFORDABILITY CALCULATOR -->
  <div id="affordabilityTab" class="tabcontent">
    <div class="container">
      <h1>Rent Affordability Calculator</h1>
      
      <label for="rent">Monthly Rent (£):</label>
      <input type="number" id="rent" aria-label="Monthly Rent in pounds" placeholder="Enter your monthly rent" />
      
      <label for="income">Your Annual Income (£):</label>
      <input type="number" id="income" aria-label="Your Annual Income in pounds" placeholder="Enter your annual income (optional)" />
      
      <label for="incomeSlider">Adjust Income (Slider, rounds to nearest £100):</label>
      <input type="range" id="incomeSlider" min="0" max="300000" step="100" value="0">
      
      <button onclick="calculateIncome()">Calculate</button>
      
      <p class="result" id="tenantResult"></p>
      <p class="result" id="guarantorResult"></p>
      <p class="result" id="affordabilityResult"></p>
    </div>
    <canvas id="affordabilityChart" width="500" height="250"></canvas>
  </div>

  <!-- TAB 2: RENT INCREASE CALCULATOR -->
  <div id="rentIncreaseTab" class="tabcontent">
    <div class="container">
      <h1>Rent Increase Calculator</h1>
      <p style="text-align: center;">
        Enter your current rent and the open market rent below to see the allowed increase.
      </p>
      
      <label for="currentRentInput">Current Rent (C):</label>
      <input type="number" id="currentRentInput" min="1" step="0.01" placeholder="e.g. 800" />
      
      <label for="openMarketRentInput">Open Market Rent (M):</label>
      <input type="number" id="openMarketRentInput" min="1" step="0.01" placeholder="e.g. 900" />
      
      <button onclick="calculateRentIncrease()">Calculate Allowed Increase</button>
      
      <div id="rentIncreaseResult" class="result" style="display: none;"></div>

      <p style="font-size: 0.9em; color: #666; text-align: center;">
        <em>Note:</em> If the market difference is 6% or less, no increase is allowed 
        (refer to legislation). Differences above 25% are capped at 25%.
      </p>
    </div>
  </div>

  <!-- Secret Game Button -->
  <button id="secretButton">?</button>
  
  <!-- Secret Game Overlay -->
  <div id="gameContainer">
    <div id="gameContent">
      <h2>Secret Game: Click the Circle!</h2>
      <p>Score: <span id="gameScore">0</span> | Time Left: <span id="gameTimer">10</span>s</p>
      <canvas id="gameCanvas" width="400" height="300" style="border: 1px solid #333; background: #f9f9f9;"></canvas>
      <br>
      <button id="playAgainButton" style="display:none;">Play Again</button>
      <button id="closeGameButton" style="margin-top: 10px;">Close Game</button>
    </div>
  </div>

  <script>
    // ---------------------- TAB LOGIC ----------------------
    function openTab(evt, tabName) {
      // Hide all tabcontent
      var tabcontent = document.getElementsByClassName("tabcontent");
      for (var i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
      }
      // Remove "active" from all tablinks
      var tablinks = document.getElementsByClassName("tablinks");
      for (var i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
      }
      // Show the current tab
      document.getElementById(tabName).style.display = "block";
      // Add an "active" class to the button that opened the tab
      evt.currentTarget.className += " active";
    }
    // Automatically open the first tab on page load
    document.getElementById("defaultOpen").click();

    // ---------------------- DARK/LIGHT MODE ----------------------
    const toggleThemeBtn = document.getElementById('toggleTheme');
    toggleThemeBtn.addEventListener('click', () => {
      document.body.classList.toggle('dark');
      document.body.classList.toggle('light');
      toggleThemeBtn.textContent = document.body.classList.contains('dark')
        ? "Switch to Light Mode"
        : "Switch to Dark Mode";
    });

    // ---------------------- RENT AFFORDABILITY CALCULATOR ----------------------
    // Real-time calculation on rent input change
    document.getElementById('rent').addEventListener('input', calculateIncome);

    // Income text input and slider synchronization
    const incomeText = document.getElementById('income');
    const incomeSlider = document.getElementById('incomeSlider');

    // When the text input changes, update the slider (rounded to the nearest £100)
    incomeText.addEventListener('input', function() {
      const value = parseFloat(this.value);
      if (!isNaN(value)) {
        incomeSlider.value = Math.round(value / 100) * 100;
      }
      calculateIncome();
    });

    // When the slider changes, round its value, update text, recalc
    incomeSlider.addEventListener('input', function() {
      let sliderValue = Math.round(parseFloat(this.value) / 100) * 100;
      this.value = sliderValue;
      incomeText.value = sliderValue;
      calculateIncome();
    });

    function calculateIncome() {
      const rentInput = document.getElementById('rent');
      const tenantResult = document.getElementById('tenantResult');
      const guarantorResult = document.getElementById('guarantorResult');
      const affordabilityResult = document.getElementById('affordabilityResult');
      const rent = parseFloat(rentInput.value);
      const userIncome = parseFloat(incomeText.value);

      // Validate rent
      if (isNaN(rent) || rent < 0) {
        tenantResult.textContent = "Please enter a valid positive number for rent.";
        guarantorResult.textContent = "";
        affordabilityResult.textContent = "";
        clearCanvas();
        return;
      }

      // Required incomes
      const tenantIncomeRequired = rent * 30;
      const guarantorIncomeRequired = rent * 36;
      tenantResult.textContent = "Minimum Tenant Annual Income: £" + tenantIncomeRequired.toLocaleString();
      guarantorResult.textContent = "Minimum Guarantor Annual Income: £" + guarantorIncomeRequired.toLocaleString();

      // Affordability check
      if (!isNaN(userIncome) && userIncome >= 0) {
        if (userIncome >= tenantIncomeRequired) {
          affordabilityResult.textContent = "Your income is AFFORDABLE for this rent.";
          affordabilityResult.style.color = "green";
        } else {
          affordabilityResult.textContent = "Your income is UNAFFORDABLE for this rent.";
          affordabilityResult.style.color = "red";
        }
      } else {
        affordabilityResult.textContent = "";
      }

      // Draw the graph if user income is provided
      if (!isNaN(userIncome) && userIncome >= 0) {
        animateMarker(tenantIncomeRequired, userIncome);
      } else {
        drawGraph(tenantIncomeRequired, userIncome, 8);
      }
    }

    // Clear the canvas
    function clearCanvas() {
      const canvas = document.getElementById('affordabilityChart');
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    // Draw the graph (with optional marker radius for animation)
    function drawGraph(threshold, userIncome, markerRadius = 8) {
      const canvas = document.getElementById('affordabilityChart');
      const ctx = canvas.getContext('2d');
      const width = canvas.width;
      const height = canvas.height;
      
      // Clear
      ctx.clearRect(0, 0, width, height);

      // Graph margins
      const marginLeft = 50;
      const marginRight = 20;
      const marginTop = 30;
      const marginBottom = 40;
      const graphWidth = width - marginLeft - marginRight;

      // Determine max value for x-axis
      let maxValue = threshold;
      const userIncomeVal = !isNaN(userIncome) ? userIncome : 0;
      if (userIncomeVal > maxValue) {
        maxValue = userIncomeVal;
      }
      maxValue *= 1.2;

      // Draw x-axis
      ctx.beginPath();
      ctx.moveTo(marginLeft, height - marginBottom);
      ctx.lineTo(width - marginRight, height - marginBottom);
      ctx.strokeStyle = "#333";
      ctx.lineWidth = 2;
      ctx.stroke();

      // Ticks & labels
      const numTicks = 5;
      ctx.fillStyle = "#333";
      ctx.textAlign = "center";
      ctx.textBaseline = "top";
      for (let i = 0; i <= numTicks; i++) {
        const xPos = marginLeft + (i / numTicks) * graphWidth;
        const tickValue = (i / numTicks) * maxValue;
        ctx.beginPath();
        ctx.moveTo(xPos, height - marginBottom);
        ctx.lineTo(xPos, height - marginBottom + 5);
        ctx.stroke();
        ctx.fillText("£" + Math.round(tickValue).toLocaleString(), xPos, height - marginBottom + 8);
      }

      function valueToX(value) {
        return marginLeft + (value / maxValue) * graphWidth;
      }

      // Threshold line
      const thresholdX = valueToX(threshold);
      ctx.beginPath();
      ctx.moveTo(thresholdX, marginTop);
      ctx.lineTo(thresholdX, height - marginBottom);
      ctx.strokeStyle = "red";
      ctx.setLineDash([5, 5]);
      ctx.stroke();
      ctx.setLineDash([]);
      ctx.fillStyle = "red";
      ctx.textAlign = "center";
      ctx.fillText("Threshold: £" + threshold.toLocaleString(), thresholdX, marginTop - 20);

      // User income marker
      if (!isNaN(userIncome) && userIncome >= 0) {
        const userX = valueToX(userIncome);
        ctx.beginPath();
        ctx.arc(userX, height - marginBottom, markerRadius, 0, Math.PI * 2);
        ctx.fillStyle = userIncome >= threshold ? "green" : "red";
        ctx.fill();
        ctx.strokeStyle = "#333";
        ctx.stroke();
        ctx.fillStyle = "#333";
        ctx.textAlign = "center";
        ctx.fillText("Your Income: £" + userIncome.toLocaleString(), userX, height - marginBottom + 15);
      }
    }

    // Animate the marker from radius 0 to 8 over 500ms
    function animateMarker(threshold, userIncome) {
      const duration = 500;
      const finalRadius = 8;
      let startTime = null;

      function animationStep(timestamp) {
        if (!startTime) startTime = timestamp;
        let progress = timestamp - startTime;
        let currentRadius = Math.min(finalRadius, (progress / duration) * finalRadius);
        drawGraph(threshold, userIncome, currentRadius);
        if (currentRadius < finalRadius) {
          requestAnimationFrame(animationStep);
        }
      }
      requestAnimationFrame(animationStep);
    }

    // ---------------------- RENT INCREASE CALCULATOR (TAB 2) ----------------------
    function calculateRentIncrease() {
      const currentRentInput = document.getElementById('currentRentInput');
      const openMarketRentInput = document.getElementById('openMarketRentInput');
      const resultDiv = document.getElementById('rentIncreaseResult');
      resultDiv.style.display = 'block'; // Show the result area

      // 1) Get user inputs
      const currentRent = parseFloat(currentRentInput.value);
      const openMarketRent = parseFloat(openMarketRentInput.value);

      // Validate
      if (isNaN(currentRent) || isNaN(openMarketRent) || currentRent <= 0 || openMarketRent <= 0) {
        resultDiv.innerHTML = "<p>Please enter valid positive numbers for both rents.</p>";
        return;
      }

      // 2) Compute Market Difference %
      const difference = openMarketRent - currentRent;
      const marketDiffPercent = (difference / currentRent) * 100;

      // 3) If difference <= 6%, no increase
      if (marketDiffPercent <= 6) {
        resultDiv.innerHTML = `
          <p><strong>Market Difference:</strong> ${marketDiffPercent.toFixed(2)}%</p>
          <p><em>No increase allowed (≤ 6%). Refer to legislation.</em></p>
        `;
        return;
      }

      // 4) Cap difference at 25%
      const usedDiffPercent = Math.min(marketDiffPercent, 25);

      // Tapering formula:
      // New Rent = floor( C × ((106 + (usedDiffPercent - 6)/3) / 100) )
      const newRent = Math.floor(
        currentRent * ((106 + ((usedDiffPercent - 6) / 3)) / 100)
      );

      // 5) Display results
      const increaseAmount = newRent - currentRent;
      let cappedNote = '';
      if (marketDiffPercent > 25) {
        cappedNote = `
          <p style="color: #d00;">
            (Your actual difference was ${marketDiffPercent.toFixed(2)}%, 
            but it was capped at 25%.)
          </p>
        `;
      }

      resultDiv.innerHTML = `
        <p><strong>Market Difference:</strong> ${marketDiffPercent.toFixed(2)}%</p>
        ${cappedNote}
        <p><strong>New Rent (rounded down):</strong> £${newRent.toFixed(2)}</p>
        <p><strong>Increase Amount:</strong> £${increaseAmount.toFixed(2)}</p>
      `;
    }

    // ---------------------- SECRET GAME ----------------------
    const secretButton = document.getElementById('secretButton');
    const gameContainer = document.getElementById('gameContainer');
    const closeGameButton = document.getElementById('closeGameButton');
    const playAgainButton = document.getElementById('playAgainButton');
    const gameScoreSpan = document.getElementById('gameScore');
    const gameTimerSpan = document.getElementById('gameTimer');
    const gameCanvas = document.getElementById('gameCanvas');
    const gameCtx = gameCanvas.getContext('2d');
    
    let gameScore = 0;
    let gameTime = 10; // seconds
    let gameInterval;
    let circleX, circleY;
    const circleRadius = 30;
    
    function startGame() {
      gameScore = 0;
      gameTime = 10;
      gameScoreSpan.textContent = gameScore;
      gameTimerSpan.textContent = gameTime;
      playAgainButton.style.display = "none";
      gameCanvas.addEventListener('click', canvasClickHandler);
      drawCircle();
      gameInterval = setInterval(() => {
        gameTime--;
        gameTimerSpan.textContent = gameTime;
        if (gameTime <= 0) {
          endGame();
        }
      }, 1000);
    }
    
    function endGame() {
      clearInterval(gameInterval);
      gameCanvas.removeEventListener('click', canvasClickHandler);
      playAgainButton.style.display = "inline-block";
    }
    
    function canvasClickHandler(event) {
      const rect = gameCanvas.getBoundingClientRect();
      const mouseX = event.clientX - rect.left;
      const mouseY = event.clientY - rect.top;
      const dist = Math.sqrt((mouseX - circleX) ** 2 + (mouseY - circleY) ** 2);
      if (dist <= circleRadius) {
        gameScore++;
        gameScoreSpan.textContent = gameScore;
        drawCircle();
      }
    }
    
    function drawCircle() {
      gameCtx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);
      circleX = Math.random() * (gameCanvas.width - 2 * circleRadius) + circleRadius;
      circleY = Math.random() * (gameCanvas.height - 2 * circleRadius) + circleRadius;
      gameCtx.beginPath();
      gameCtx.arc(circleX, circleY, circleRadius, 0, Math.PI * 2);
      gameCtx.fillStyle = "#007BFF";
      gameCtx.fill();
    }
    
    secretButton.addEventListener('click', () => {
      gameContainer.style.display = "block";
      startGame();
    });
    
    closeGameButton.addEventListener('click', () => {
      gameContainer.style.display = "none";
      clearInterval(gameInterval);
    });
    
    playAgainButton.addEventListener('click', () => {
      startGame();
    });
  </script>
</body>
</html>
